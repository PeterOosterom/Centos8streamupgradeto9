---
  - name: Centos pre-upgrade
    hosts: test
    become: yes
    become_user: root
    tasks:
    
      - name: ensure git 
        yum:
          name: git
          state: latest
          
      - name: Check if base repo exists
        stat:
          path: "/etc/yum.repos.d/CentOS-Base.repo"
        register: repo

      - name: Copy centos base repo from Github
        git:
          repo: https://github.com/DigistateBV/centos7-repo.git
          dest: /root/repo
          clone: yes
          update: yes
        when: not repo.stat.exists

      - name: Ensure base repo
        command: cp /root/repo/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo
        args:
          warn: false
        when: not repo.stat.exists

      - name: Install system updates for centos systems
        yum:
          name: '*'
          state: latest
          update_cache: yes
         #cache_valid_time: 3600


#reboot zodat eventuele nieuwe kernels gebruikt worden

      - name: Reboot host and wait for it to restart
        reboot:
          msg: "Reboot initiated by Ansible"
          connect_timeout: 5
          reboot_timeout: 600
          pre_reboot_delay: 0
          post_reboot_delay: 30
          test_command: whoami
          
      - name: clean yum
        command: /bin/yum clean all 
        args:
          warn: false

      - name: Install DNF
        yum:
          name: dnf
          state: present


#installeer de benodigdeheden voor Elevate
      - name: ensure ELevate
        yum:
          name: "http://repo.almalinux.org/elevate/elevate-release-latest-el7.noarch.rpm"
          state: present

      - name: ensure leapp-upgrade
        yum:
          name: leapp-upgrade
          state: present

      - name: ensure leapp-data-centos
        yum:
          name: leapp-data-centos
          state: present
           
      - name: ensure yum-utils
        yum:
          name: yum-utils
          state: present


      - name: Remove old kernels
        command: package-cleanup -y --oldkernels --count=1

        
      - name: create leapp directory
        file:
          path: /var/log/leapp/
          state: directory

        
      - name: create leapp answerfile
        copy:
          dest: /var/log/leapp/answerfile
          content: |
            [remove_pam_pkcs11_module_check]
            confirm = True

        
      - name: Cleanup previous preupgrade reports
        file:
          path: '{{ item }}'
          state: absent
        loop:
          - /var/log/leapp/leapp-report.txt
          - /var/log/leapp/leapp-report.json

        
      - name: Generate leapp preupgrade report
        command: leapp preupgrade
        args:
          creates: /var/log/leapp/leapp-report.txt
        ignore_errors: yes
        register: leapp_preupgrade

        
      - name: Debug leapp preupgrade output
        debug:
          var: leapp_preupgrade
          verbosity: 2

        
      - name: Upgrade
        command: leapp upgrade

        
      - name: Reboot host and wait for it to restart
        reboot:
          msg: "Reboot initiated by Ansible"
          connect_timeout: 5
          reboot_timeout: 600
          pre_reboot_delay: 0
          post_reboot_delay: 30
          test_command: whoami

 
  - name: Centos post-upgrade
    hosts: test
    become: yes
    become_user: root
    vars:
      ansible_python_interpreter: /usr/bin/python3
    tasks:

      - name: Remove Leapp deps
        command: dnf remove -y yum-plugin-fastestmirror leapp elevate python2-leapp elevate-release leapp-data-centos btrfs-progs leapp-repository-deps-el8 --disableexcludes=all
        args:
          warn: false
          
      - name: create python symlink
        command: ln -fs /usr/bin/python2 /usr/bin/python
        args:
          warn: false
          
          
      - name: clean yum
        command: /bin/yum clean all 
        args:
          warn: false



          
