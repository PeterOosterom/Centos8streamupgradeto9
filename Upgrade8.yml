---
  - name: Centos pre-upgrade
    hosts: test
    become: yes
    become_user: root
    vars:
      ansible_python_interpreter: /usr/bin/python3
    tasks:

      
      - name: update
        command: dnf update -y --allowerasing
        args:
          warn: false
          
      - name: ensure Centos 9 repos
        command: dnf install -y http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-stream-repos-9.0-18.el9.noarch.rpm http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-stream-release-9.0-18.el9.noarch.rpm http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-gpg-keys-9.0-18.el9.noarch.rpm
        args:
          warn: false

      - name: remove old repos
        command: rm -f /etc/yum.repos.d/docker-ce.repo /etc/yum.repos.d/pgdg-redhat-all.repo
        args:
          warn: false
          
      - name: remove broken packages
        dnf:
          name: make-devel-1:4.2.1-11.el8.x86_64
          state: absent

      - name: update
        command: dnf -y --releasever=9-stream --allowerasing --setopt=deltarpm=false distro-sync
        args:
          warn: false
